{% extends "contest.html" %}

{% set page = "test_interface" %}

{% block additional_js %}
document.addEventListener("DOMContentLoaded", () => {
    const submissionDetailModal = document.getElementById("user_test_detail");
    submissionDetailModal.addEventListener("show.bs.modal", async (event) => {
        const button = event.relatedTarget;
        const taskId = button.closest("[data-task]").getAttribute("data-task");
        const userTestId = button.closest("[data-user-test]").getAttribute("data-user-test");
        const modalBody = submissionDetailModal.querySelector(".modal-body");
        modalBody.innerHTML = `{% include "components/spinner.html" %}`;
        const response = await fetch(
            utils.contest_url("tasks", taskId, "tests", userTestId, "details"),
        );
        modalBody.innerHTML = await response.text();
    });
});

function is_status_terminal (status) {
    return status == {{ UserTestResult.COMPILATION_FAILED }}
        || status == {{ UserTestResult.EVALUATED }};
};

update_user_test_row = function (task_id, user_test_id, data) {
    var row = $(".user_test_list[data-task=\"" + task_id + "\"] tbody tr[data-user-test=\"" + user_test_id + "\"]");
    row.attr("data-status", data["status"]);
    row.find("td.status > div").html(data["status_text"]);
    var terminal_status = is_status_terminal(data["status"]);
    if (!terminal_status) {
        row.find("td.status > div").append(`{% include "components/spinner.html" %}`);
    } else {
        row.find("td.status > div").append($(`{% include "components/user_test_detail_button.html" %}`));
    }
    if (data["status"] == {{ UserTestResult.EVALUATED }}) {
        if (data["output"]) {
            var btn = row.children("td.output").children("a.btn");
            btn.text('{% trans %}Download{% endtrans %}');
            btn.removeClass("disabled");
            btn.attr("href", utils.contest_url("tasks", task_id, "tests", user_test_id, "output"));
        } else {
            row.children("td.output").children("a.btn").text("{% trans %}N/A{% endtrans %}");
        }
        if (data["execution_time"] != null) {
            row.children("td.execution_time").removeClass("text-body-secondary");
            row.children("td.execution_time").removeClass("undefined");
            row.children("td.execution_time").text(data["execution_time"]);
        }
        if (data["memory"] != null) {
            row.children("td.memory").removeClass("text-body-secondary");
            row.children("td.memory").removeClass("undefined");
            row.children("td.memory").text(data["memory"]);
        }
    } else if (data["status"] == {{ UserTestResult.COMPILATION_FAILED }}) {
        row.children("td.output").children("a.btn").text("{% trans %}N/A{% endtrans %}");
    } else {
        schedule_update_user_test_row(task_id, user_test_id);
    }
}

schedule_update_user_test_row = function (task_id, user_test_id) {
    setTimeout(function () {
        $.get(utils.contest_url("tasks", task_id, "tests", user_test_id), function (data) {
            update_user_test_row(task_id, user_test_id, data);
        });
    }, 2000);
}

$(document).ready(function () {
    $('.user_test_list tbody tr[data-status][data-status!="{{ UserTestResult.COMPILATION_FAILED }}"][data-status!="{{ UserTestResult.EVALUATED }}"]').each(function (idx, elem) {
        var $this = $(this);
        schedule_update_user_test_row($this.parent().parent().attr("data-task"), $this.attr("data-user-test"));
    });
});
{% endblock additional_js %}

{% block core %}


<ul class="nav nav-tabs">
{% for task in contest.tasks %}
    {% set task_type = get_task_type(dataset=task.active_dataset) %}
    {% if task_type.testable %}
    <li class="nav-item"><a class="nav-link{% if task == default_task %} active{% endif %}" href="#test_{{ task.name }}" data-bs-toggle="tab">{{ task.name }}</a></li>
    {% endif %}
{% endfor %}
</ul>

<div class="tab-content pt-4">
{% for task in contest.tasks %}
    {% set task_type = get_task_type(dataset=task.active_dataset) %}
    {% if task_type.testable %}
<div class="tab-pane{% if task == default_task %} active{% endif %} row g-4" id="test_{{ task.name }}">

{% set two_column_submission =
    not (task.submission_format + task_type.get_user_managers())|any("endswith", ".%l") %}

{% if two_column_submission %}
  <div class="col-12">{% include "components/test_card.html" %}</div>
{% else %}
  <div class="col-8 offset-2">{% include "components/test_card.html" %}</div>
{% endif %}


{# BEGIN: previous tests #}
<div class="col-12">
<div class="card shadow rounded-4">
    <div class="card-body">
        <h3 class="card-title">{% trans %}Previous tests{% endtrans %}</h3>

{% set show_date = not user_tests[task.id]|map(attribute="timestamp")|all("today") %}

    <div class="table-responsive">
    <table class="table table-bordered table-hover text-center align-middle user_test_list" data-task="{{ task.name }}">
        <colgroup>
    {% if show_date %}
            <col class="datetime"/>
    {% else %}
            <col class="time"/>
    {% endif %}
            <col class="status"/>
            <col class="time"/>
            <col class="memory"/>
            <col class="input"/>
            <col class="output"/>
            <col class="files"/>
        </colgroup>
        <thead>
            <tr>
    {% if show_date %}
                <th class="datetime">{% trans %}Date and time{% endtrans %}</th>
    {% else %}
                <th class="time">{% trans %}Time{% endtrans %}</th>
    {% endif %}
                <th class="status">{% trans %}Status{% endtrans %}</th>
                <th class="time">{% trans %}Execution time{% endtrans %}</th>
                <th class="memory">{% trans %}Memory used{% endtrans %}</th>
                <th class="input">{% trans %}Input{% endtrans %}</th>
                <th class="output">{% trans %}Output{% endtrans %}</th>
                <th class="files">{% trans %}Files{% endtrans %}</th>
            </tr>
        </thead>
        <tbody>
        {% for t in user_tests[task.id]|sort(attribute="timestamp")|reverse %}
            {# loop.revindex is broken: https://github.com/pallets/jinja/issues/794 #}
            {% set t_idx = user_tests[task.id]|length - loop.index0 %}
            {% set tr = t.get_result(t.task.active_dataset) or undefined %}
            {% include "user_test_row.html" %}
        {% else %}
            <tr>
                <td colspan="7" class="fst-italic fs-4 text-body-secondary">
                    {% trans %}no tests yet{% endtrans %}
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    </div>

    </div>

</div>
</div>
{# END: previous submissions #}


</div>
    {% endif %}
{% endfor %}
</div>

{% endblock core %}

{% block modal %}
<div class="modal fade" id="user_test_detail">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">{% trans %}Test details{% endtrans %}</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body d-flex justify-content-center">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock modal %}
